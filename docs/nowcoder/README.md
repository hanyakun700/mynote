---
title: 埋点体系
---

埋点是一整套流程下来的, 需要相关平台以及部门作为支持

本着谁用谁负责, 数据要作为收口方,保证数据质量

## 埋点开发流程

#### 产生阶段：
- 产运

  根据业务场景 出埋点文档
- 数据
  - 埋点评审
    
    - 必要性：采用埋点方式是否合理，能否通过别的方案获取
    
    - 合理性：严格审查 事件名/字段名/字段枚举值的合理性/规范性  
      - 合理：字段是否该上传 业务表是否可以拿到 
      
      - 规范性
              小驼峰命名 id采用ID 字段尽量精简避免冗余 短的、常用的字段可以冗余 长字段肯行不行 如帖子内容
              时效性字段

    - 对于数据量大的埋点更应该重视 减少字段对传输影响很大 对于数据量级小的 对应分析不那么重要的 可以放宽点

  - 添加监控
    在埋点监控平台配置监控规则
    数据发到kafka后 按照配置的事件规则进行计算 并将结果保存带influxDB中 缓存的是7天的数据 但只能实时统计30min 此时可以拿到错误的数据
    在mysql表中只记录事件每小时的正确和错误条数 日增量为 400个 * 24h = 9600条，据此可以计算错误率、同比、周环比、环比等 

#### 开发阶段
- 前端

  需要按照不同版本ios、android、pc端 上报埋点 保证数据可靠

#### 测试阶段
- 测试

  数据是否符合预期

- 数据
  
  提供埋点监控平台 提供全量测试数据结果展示及正确率等指标

#### 维护阶段
- 数据
  
  负责埋点日常的监控和维护 如果有偶发的数据量激增或者减少要有报警

#### 下线阶段
  有的埋点用于业务的持续优化 一直做分析 比如曝光埋点
  
  有的埋点是版本迭代实验性的 可能会被遗弃
  
- 前端
  将埋点代码下掉
- 数据
  将该埋点状态改为失效

## 埋点的处理
  数据从kafka入仓到 小时分区的表 然后小时级别json解析得到全部事件的表
  
  天级别解析得到单一事件表
  
  对于一些埋点太多且业务集中的情况 可以将多个事件解析到一张表中 减少代码量

### 埋点分类
- 前端埋点 
    - 事件驱动  
      什么是事件  点击 浏览 停留 等等
      前端埋点通常带的信息比较丰富 但比较乱 存在埋不全 质量差

- 后端埋点 
    - 接口驱动  
      触发接口时 会带着数据 同时这些数据也可以在后端作为查询条件去关联其他业务表 或者落表
  

### 埋点的数据探查

#### 数据链路

1.后端会将生成的信息先传到前端或者客户端 即 pc和app 如trackid entityid等 由算法部得到 @云旺  数据透传

2.pc和app将事件触发的埋点发到转发服务器的kafka上 topic为sdk-food

3.sdk-food的数据发两份：一份同步到gio供产品在gio平台查询；一份消费的时候添加实验组参数，同步到算法的kafka

4.算法的kafka数据分两份：一份入仓 ods_log_user_event_hour_inc ；一份按事件的配置规则做质量分析 结果存到influxDB 支撑埋点监控 

#### 内容详解
- 事件类型
```text
   埋点事件
    vstr 访问用户变量
    vst
    clck
    sbmt
    chng
    cstm 自定义用户变量
    page
    ppl  登录用户变量
    cls
  无埋点事件
    vst 访问事件 单独一张表 作为无埋点事件之一 带了客户端版本 
```

  - 公共字段
  ```text
    u    cuid     访问用户ID            '5936abfd-cdb2-4173-a71b-7d542f663463' 
    
    s    session  访问ID（session id）  '559602f3-a551-4dcd-be8b-3555edd36a26' 
    cs1  uid      登录用户ID            '394448640' 
    t    type     事件类型              'cstm'             
    n    event    事件名称              'contentItemView'  
    var  data     埋点数据
    ptm  page_view_time  页面浏览时间    1653289611423            
    tm   event_time  事件发生时间        1653289628465  

    -- 组成访问的地址domain/page?query
    d    domain 域名        'www.nowcoder.com'    
    p    page  页面         '/jobs/company-project'    
    q    query 查询参数      'projectId=588&recruitType=2&activityId=13&activitySuffix=internoffer&deliverSource=13&channel=adv_jobtop'

    ip
    b    platform  平台 web/ios/andriod
    ua   client    user agent 访问客户端 浏览器版本/手机型号

    cstm    c客户端发送时间(毫秒)
    stm     s服务器收到的时间(毫秒) 
    system_time 系统时间

    ptm < tm < cstm < stm < system_time

```
     